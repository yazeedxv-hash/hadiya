<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù‡Ø¯ÙŠØ©</title>
  <meta name="description" content="Ù‡Ø¯ÙŠØ©: Ø±Ø§Ø¨Ø· ÙˆØ§Ø­Ø¯ + Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ù…Ø§Ø¡ + Ø±Ù…Ø² 3 Ø£Ø±Ù‚Ø§Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1220;--muted:#9aa7bd;--text:#eef3ff;--accent:#7c5cff;--danger:#ef4444;--border:rgba(255,255,255,.08);--shadow:0 12px 35px rgba(0,0,0,.35);--radius:16px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 800px at 80% -20%,rgba(124,92,255,.35),transparent 55%),radial-gradient(900px 700px at 10% 0%,rgba(34,197,94,.18),transparent 55%),var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;}
    .wrap{width:min(1020px,100%)}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,rgba(124,92,255,.95),rgba(34,197,94,.75));box-shadow:var(--shadow);display:grid;place-items:center;font-size:22px}
    h1{margin:0;font-weight:800}
    .subtitle{margin:4px 0 0;color:var(--muted);font-size:14px}
    .pill{border:1px solid var(--border);padding:10px 12px;border-radius:999px;color:var(--muted);font-size:13px;display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.03)}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}header{flex-direction:column;align-items:flex-start}}
    .card{background:rgba(18,26,43,.88);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .head{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .head h2{margin:0;font-size:16px;font-weight:800}
    .body{padding:16px 18px}
    label{display:block;margin:0 0 8px;color:var(--muted);font-size:13px}
    textarea,input,select{width:100%;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 12px;font-family:inherit;font-size:15px;outline:none}
    textarea{min-height:190px;resize:vertical;line-height:1.75}
    input,select{height:44px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:600px){.row{grid-template-columns:1fr}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;border-radius:12px;padding:11px 14px;font-family:inherit;font-weight:800;cursor:pointer;color:#0b1220;background:linear-gradient(135deg,var(--accent),#a78bfa)}
    button.secondary{background:rgba(255,255,255,.06);color:var(--text);border:1px solid var(--border);font-weight:700}
    button.danger{background:rgba(239,68,68,.12);color:#fecaca;border:1px solid rgba(239,68,68,.28);font-weight:800}
    button.copy{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.28);color:#bbf7d0}
    .hint{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.7}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--muted);line-height:1.7;word-break:break-word}
    .msg strong{color:var(--text)}
    .hide{display:none!important}
    .tiny{font-size:12px;color:var(--muted)}
    .footer{margin-top:14px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:10px 12px;text-align:right}
    thead th{color:var(--muted);font-weight:800;font-size:12px}
    tbody td{background:rgba(255,255,255,.03);border:1px solid var(--border)}
    tbody td:first-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    tbody td:last-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">ğŸ</div>
        <div>
          <h1>Ù‡Ø¯ÙŠØ©</h1>
          <div class="subtitle">Ø±Ø§Ø¨Ø· ÙˆØ§Ø­Ø¯ + Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ù…Ø§Ø¡ + Ø±Ù…Ø² 3 Ø£Ø±Ù‚Ø§Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
        </div>
      </div>
      <div class="pill"><span>ğŸ”’</span><span>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§ ØªÙØ±Ø³Ù„ Ù„Ø£ÙŠ Ø³ÙŠØ±ÙØ±</span></div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="head"><h2>Ø§Ù„Ù…Ù†Ø¸Ù‘Ù…</h2><span class="badge">ÙŠÙˆÙ„Ù‘Ø¯ Ø±Ø§Ø¨Ø· + Ø±Ù…ÙˆØ²</span></div>
        <div class="body">
          <div id="restoreBanner" class="msg hide"></div>

          <label for="eventName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="eventName" placeholder="Ù…Ø«Ø§Ù„: Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…ÙƒØªØ¨ / ÙØ¹Ø§Ù„ÙŠØ© Ø§Ù„Ù‚Ø±ÙˆØ¨" />

          <div class="row">
            <div><label for="budget">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="budget" placeholder="Ù…Ø«Ø§Ù„: 100 Ø±ÙŠØ§Ù„" /></div>
            <div><label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="notes" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù…Ù†ÙˆØ¹ Ù‡Ø¯Ø§ÙŠØ§ Ù…Ø²Ø§Ø­ Ø«Ù‚ÙŠÙ„Ø© ğŸ˜„" /></div>
          </div>

          <div style="margin-top:12px">
            <label for="names">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±)</label>
            <textarea id="names" placeholder="Ø³Ù„ÙŠÙ…Ø§Ù†&#10;ØªØ±ÙƒÙŠ&#10;Ù†ÙˆØ±Ø©&#10;Ø³Ø§Ø±Ø©"></textarea>
          <div id="nameCount" class="tiny" style="margin-top:6px">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡: 0</div>
          </div>

          <div class="btns">
            <button id="btnMake" type="button">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ø±Ù…ÙˆØ²</button>
            <button id="btnShuffleOnly" class="secondary" type="button">Ø®Ù„Ø· ÙÙ‚Ø·</button>
            <button id="btnClear" class="danger" type="button">Ù…Ø³Ø­</button>
          </div>

          <div class="hint">
            âœ… Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯: Ø£Ø±Ø³Ù„ <strong>Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§Ø­Ø¯</strong> Ø¨Ø§Ù„Ù‚Ø±ÙˆØ¨ØŒ Ø«Ù… Ø£Ø±Ø³Ù„ <strong>Ø±Ù…Ø² 3 Ø£Ø±Ù‚Ø§Ù…</strong> Ù„ÙƒÙ„ Ø´Ø®Øµ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Øµ.<br>
            ğŸ’¾ ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ (Ù†ÙØ³ Ø§Ù„Ø¬ÙˆØ§Ù„/Ø§Ù„Ù…ØªØµÙØ­).
          </div>
        </div>
      </section>

      <section class="card">
        <div class="head"><h2>Ø§Ù„Ø±Ø§Ø¨Ø· + Ø±Ù…ÙˆØ² 3 Ø£Ø±Ù‚Ø§Ù…</h2><span class="badge">Ø§Ù†Ø³Ø® ÙˆØ£Ø±Ø³Ù„</span></div>
        <div class="body">
          <div id="linkBox" class="msg">Ø§Ø¶ØºØ· <strong>ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ø±Ù…ÙˆØ²</strong> Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ù…ÙˆØ².</div>

          <div class="btns">
            <button id="btnCopyLink" class="copy hide" type="button">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
            <button id="btnOpenGuest" class="secondary hide" type="button">ÙØªØ­ ÙƒØ¶ÙŠÙ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
            <button id="btnCopyCodes" class="secondary hide" type="button">Ù†Ø³Ø® Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ù…ÙˆØ²</button>
            <button id="btnBackup" class="secondary hide" type="button">Ù†Ø³Ø® (Ø§Ù„Ø±Ø§Ø¨Ø· + Ø§Ù„Ø±Ù…ÙˆØ²)</button>
          </div>

          <div id="codesBox" class="hide" style="margin-top:12px"></div>

          <div class="footer">
            <div>Â© <span id="year"></span> Ù‡Ø¯ÙŠØ©</div>
            <div class="tiny">ØªÙ†Ø¨ÙŠÙ‡: Ø±Ù…Ø² 3 Ø£Ø±Ù‚Ø§Ù… ÙŠÙƒÙÙŠ Ù„Ù„Ù‚Ø±ÙˆØ¨Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©.</div>
          </div>
        </div>
      </section>
    </div>

    <div id="guestView" class="card hide" style="margin-top:16px">
      <div class="head"><h2>Ø§Ù„Ø¶ÙŠÙ: Ù†ØªÙŠØ¬ØªÙƒ</h2><span class="badge">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ + Ø±Ù…Ø²Ùƒ</span></div>
      <div class="body">
        <div id="guestMeta" class="msg"></div>

        <div class="row" style="margin-top:12px">
          <div>
            <label for="guestSelect">Ø§Ø³Ù…Ùƒ</label>
            <select id="guestSelect"><option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒâ€¦</option></select>
          </div>
          <div>
            <label for="guestPin">Ø§Ù„Ø±Ù…Ø² (3 Ø£Ø±Ù‚Ø§Ù…)</label>
            <input id="guestPin" inputmode="numeric" maxlength="3" placeholder="Ù…Ø«Ø§Ù„: 042" class="mono" />
          </div>
        </div>

        <div class="btns">
          <button id="btnShow" type="button">Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬ØªÙŠ</button>
          <button id="btnCopyResult" class="copy hide" type="button">Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        </div>

        <div id="resultBox" class="msg hide"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  $("year").textContent = new Date().getFullYear();
  const STORAGE_KEY = "hadiya_last_draw_v1";

  function updateNameCount(){
    const names = normalizeNames(document.getElementById("names").value);
    const el = document.getElementById("nameCount");
    if(el) el.textContent = "Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡: " + names.length;
  }
  const namesEl = document.getElementById("names");
  if(namesEl){
    namesEl.addEventListener("input", updateNameCount);
    updateNameCount();
  }


  function normalizeNames(text){
    // Robust parsing across platforms:
    // - handles \n, \r, \r\n
    // - handles comma separators , and Arabic comma ØŒ
    // - strips invisible RTL/LTR marks that sometimes appear when typing Arabic
    const cleaned = String(text || "")
      .replace(/[\u200E\u200F\u202A-\u202E]/g, "")   // directional marks
      .replace(/\t/g, "\n");                          // treat tabs as new lines

    return cleaned
      .split(/[\r\n]+|[,ØŒ]+/)
      .map(s => s.trim())
      .filter(Boolean)
      .filter((v,i,a) => a.indexOf(v) === i);
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  function buildCycle(names){
    const shuffled = shuffle([...names]);
    const map = {};
    for(let i=0;i<shuffled.length;i++) map[shuffled[i]] = shuffled[(i+1)%shuffled.length];
    return {shuffled, map};
  }
  function b64urlEncode(str){
    const bytes = new TextEncoder().encode(str);
    let binary = '';
    bytes.forEach(b => binary += String.fromCharCode(b));
    const b64 = btoa(binary);
    return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }
  function b64urlDecode(str){
    const pad = str.length % 4 ? '='.repeat(4-(str.length%4)) : '';
    const b64 = (str+pad).replace(/-/g,'+').replace(/_/g,'/');
    const binary = atob(b64);
    const bytes = Uint8Array.from(binary, c => c.charCodeAt(0));
    return new TextDecoder().decode(bytes);
  }
  function baseUrl(){ return location.origin + location.pathname; }
  async function copyText(txt){ try{ await navigator.clipboard.writeText(txt); return true; }catch(e){ return false; } }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function parseTokenFromHash(){
    const h = location.hash || "";
    const m = h.match(/(?:^|#|&)d=([^&]+)/);
    return m ? m[1] : null;
  }
  const pad3 = (n) => String(n).padStart(3,"0");

  const linkBox = $("linkBox");
  const codesBox = $("codesBox");
  const btnCopyLink = $("btnCopyLink");
  const btnOpenGuest = $("btnOpenGuest");
  const btnCopyCodes = $("btnCopyCodes");
  const btnBackup = $("btnBackup");
  const restoreBanner = $("restoreBanner");

  function renderOrganizerOutputs({link, names, pins}){
    linkBox.innerHTML = `âœ… Ù‡Ø°Ø§ Ù‡Ùˆ <strong>Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§Ø­Ø¯</strong> (Ø£Ø±Ø³Ù„Ù‡ Ø¨Ø§Ù„Ù‚Ø±ÙˆØ¨):<br><span class="tiny" style="word-break:break-all">${escapeHtml(link)}</span>`;
    btnCopyLink.classList.remove("hide");
    btnOpenGuest.classList.remove("hide");
    btnCopyCodes.classList.remove("hide");
    btnBackup.classList.remove("hide");

    btnCopyLink.onclick = async () => {
      const ok = await copyText(link);
      if(ok){ btnCopyLink.textContent="âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®"; setTimeout(()=>btnCopyLink.textContent="Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·",1200); }
      else { prompt("Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠÙ‹Ø§:", link); }
    };
    btnOpenGuest.onclick = () => window.open(link, "_blank");

    codesBox.classList.remove("hide");
    const rows = names.map(n => `<tr><td>${escapeHtml(n)}</td><td class="mono">${escapeHtml(pins[n])}</td></tr>`).join("");
    codesBox.innerHTML = `
      <div class="msg">ğŸ“© Ø£Ø±Ø³Ù„ Ø±Ù…Ø² ÙƒÙ„ Ø´Ø®Øµ Ù„Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Øµ (Ø¨Ø¯ÙˆÙ† Ù…Ø§ ØªØ±Ø³Ù„ Ù„Ù‡ ØºÙŠØ±Ù‡).</div>
      <table>
        <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±Ù…Ø² (3 Ø£Ø±Ù‚Ø§Ù…)</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    btnCopyCodes.onclick = async () => {
      const lines = names.map(n => `${n}\\t${pins[n]}`).join("\\n");
      const ok = await copyText(lines);
      if(ok){ btnCopyCodes.textContent="âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®"; setTimeout(()=>btnCopyCodes.textContent="Ù†Ø³Ø® Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ù…ÙˆØ²",1200); }
      else { prompt("Ø§Ù†Ø³Ø® Ø§Ù„Ø¬Ø¯ÙˆÙ„:", lines); }
    };

    btnBackup.onclick = async () => {
      const lines = [
        "ğŸ Ù‡Ø¯ÙŠØ© â€” Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·",
        "",
        "ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·:",
        link,
        "",
        "ğŸ”¢ Ø§Ù„Ø±Ù…ÙˆØ² (Ø§Ø³Ù… \\t Ø±Ù…Ø²):",
        ...names.map(n => `${n}\\t${pins[n]}`)
      ].join("\\n");
      const ok = await copyText(lines);
      if(ok){ btnBackup.textContent="âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®"; setTimeout(()=>btnBackup.textContent="Ù†Ø³Ø® (Ø§Ù„Ø±Ø§Ø¨Ø· + Ø§Ù„Ø±Ù…ÙˆØ²)",1400); }
      else { prompt("Ø§Ù†Ø³Ø® Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:", lines); }
    };
  }

  function saveLastDraw(obj){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }catch(e){}
  }
  function loadLastDraw(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }
  function clearLastDraw(){ try{ localStorage.removeItem(STORAGE_KEY); }catch(e){} }

  function showRestoreBanner(saved){
    if(!saved) return;
    if(parseTokenFromHash()) return;

    const dt = saved.savedAt ? new Date(saved.savedAt) : null;
    const when = dt && !isNaN(dt) ? dt.toLocaleString("ar-SA") : "Ø³Ø§Ø¨Ù‚Ù‹Ø§";

    restoreBanner.classList.remove("hide");
    restoreBanner.innerHTML = `
      ğŸ’¾ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø±Ø¹Ø© Ù…Ø­ÙÙˆØ¸Ø© (${escapeHtml(when)}).<br>
      <div class="btns" style="margin-top:10px">
        <button id="btnRestoreNow" class="secondary" type="button">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
        <button id="btnForget" class="danger" type="button">Ø­Ø°Ù Ø§Ù„Ø­ÙØ¸</button>
      </div>
      <div class="tiny" style="margin-top:8px">ØªÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·.</div>
    `;
    document.getElementById("btnRestoreNow").onclick = () => restoreSaved(saved);
    document.getElementById("btnForget").onclick = () => { clearLastDraw();
    try{ updateNameCount(); }catch(e){} restoreBanner.classList.add("hide");
    try{ updateNameCount(); }catch(e){} };
  }

  function restoreSaved(saved){
    $("eventName").value = saved.eventName || "";
    $("budget").value = saved.budget || "";
    $("notes").value = saved.notes || "";
    $("names").value = (saved.names || []).join("\\n");
    if(saved.link && saved.pins && saved.names){
      renderOrganizerOutputs({link: saved.link, names: saved.names, pins: saved.pins});
    }
    restoreBanner.classList.add("hide");
  }

  $("btnMake").onclick = async () => {
    try{
    const names = normalizeNames($("names").value);
    if(names.length < 3){ alert("Ø£Ø¯Ø®Ù„ 3 Ø£Ø³Ù…Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; }
    if(names.length > 1000){ alert("Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§ Ù„Ø±Ù…Ø² 3 Ø£Ø±Ù‚Ø§Ù…."); return; }

    const title = ($("eventName").value||"").trim();
    const bud = ($("budget").value||"").trim();
    const note = ($("notes").value||"").trim();

    const assignment = buildCycle(names);

    const used = new Set();
    const pins = {};
    for(const person of names){
      let pin;
      do { pin = pad3(Math.floor(Math.random()*1000)); } while(used.has(pin));
      used.add(pin);
      pins[person] = pin;
    }

    const pairs = Object.keys(assignment.map).map(k => [k, assignment.map[k]]);
    const payload = {v:1, eventName:title, budget:bud, notes:note, pairs, pins};
    const token = b64urlEncode(JSON.stringify(payload));
    const link = baseUrl() + "#d=" + token;

    renderOrganizerOutputs({link, names, pins});

    saveLastDraw({
      savedAt: new Date().toISOString(),
      eventName: title, budget: bud, notes: note,
      names, pins, link
    });
    }catch(e){
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆÙ„ÙŠØ¯: ' + (e && e.message ? e.message : e));
      console.error(e);
    }
  
  };

  $("btnShuffleOnly").onclick = () => {
    const names = normalizeNames($("names").value);
    if(names.length < 2){ alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; }
    $("names").value = shuffle([...names]).join("\\n");
  };

  $("btnClear").onclick = () => {
    if(!confirm("ØªØ¨ØºÙ‰ ØªÙ…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡ØŸ")) return;
    $("names").value=""; $("eventName").value=""; $("budget").value=""; $("notes").value="";
    linkBox.innerHTML = "Ø§Ø¶ØºØ· <strong>ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ø±Ù…ÙˆØ²</strong> Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ù…ÙˆØ².";
    codesBox.classList.add("hide"); codesBox.innerHTML="";
    btnCopyLink.classList.add("hide"); btnOpenGuest.classList.add("hide"); btnCopyCodes.classList.add("hide"); btnBackup.classList.add("hide");
    clearLastDraw();
  };

  const t = parseTokenFromHash();
  if(t){
    try{
      const payload = JSON.parse(b64urlDecode(t));
      if(!payload || !payload.pairs || !payload.pins) throw new Error("bad");
      document.getElementById("guestView").classList.remove("hide");

      const lines = [];
      if(payload.eventName) lines.push(`ğŸ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©: <strong>${escapeHtml(payload.eventName)}</strong>`);
      if(payload.budget) lines.push(`ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: <strong>${escapeHtml(payload.budget)}</strong>`);
      if(payload.notes) lines.push(`ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: <strong>${escapeHtml(payload.notes)}</strong>`);
      if(!lines.length) lines.push("Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ ÙˆØ£Ø¯Ø®Ù„ Ø±Ù…Ø²Ùƒ Ù„Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬ØªÙƒ.");
      document.getElementById("guestMeta").innerHTML = lines.join("<br>");

      const pairMap = new Map(payload.pairs || []);
      const pins = payload.pins || {};

      const sel = document.getElementById("guestSelect");
      sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒâ€¦</option>' + Object.keys(pins).map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("");

      const resultBox = document.getElementById("resultBox");
      const btnCopyResult = document.getElementById("btnCopyResult");

      document.getElementById("btnShow").onclick = async () => {
        const name = sel.value;
        const pin = (document.getElementById("guestPin").value||"").trim();
        if(!name){ alert("Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ."); return; }
        if(!/^\\d{3}$/.test(pin)){ alert("Ø§ÙƒØªØ¨ Ø±Ù…Ø² 3 Ø£Ø±Ù‚Ø§Ù… (Ù…Ø«Ø§Ù„: 042)."); return; }
        if(!pins[name] || pins[name] !== pin){
          resultBox.classList.remove("hide"); btnCopyResult.classList.add("hide");
          resultBox.innerHTML = "âŒ Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­.";
          return;
        }
        const receiver = pairMap.get(name);
        resultBox.classList.remove("hide");
        resultBox.innerHTML = `âœ… ÙŠØ§ <strong>${escapeHtml(name)}</strong>ØŒ Ø£Ù†Øª Ø±Ø§Ø­ ØªÙ‡Ø¯ÙŠ: <strong>${escapeHtml(receiver)}</strong> ğŸ`;

        const shareLines = [];
        if(payload.eventName) shareLines.push(`ğŸ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©: ${payload.eventName}`);
        if(payload.budget) shareLines.push(`ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${payload.budget}`);
        if(payload.notes) shareLines.push(`ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: ${payload.notes}`);
        shareLines.push("");
        shareLines.push(`${name}ØŒ Ø£Ù†Øª Ø±Ø§Ø­ ØªÙ‡Ø¯ÙŠ: ğŸ ${receiver}`);
        const shareText = shareLines.join("\\n");

        btnCopyResult.classList.remove("hide");
        btnCopyResult.onclick = async () => {
          const ok = await copyText(shareText);
          if(ok){ btnCopyResult.textContent="âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®"; setTimeout(()=>btnCopyResult.textContent="Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©",1200); }
          else { prompt("Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", shareText); }
        };
      };
    }catch(e){}
  } else {
    const saved = loadLastDraw();
    showRestoreBanner(saved);
  }
})();
</script>
</body>
</html>
