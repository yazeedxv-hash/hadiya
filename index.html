<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù‡Ø¯ÙŠØ©</title>
  <meta name="description" content="Ù‡Ø¯ÙŠØ©: Ø±Ø§Ø¨Ø· ÙˆØ§Ø­Ø¯ Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙÙ‡Ø¯ÙŠÙ† Ø¨Ø³Ø±Ù‘ÙŠØ©â€”Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙˆØ´ÙˆÙ Ù…ÙŠÙ† Ø±Ø§Ø­ ØªÙ‡Ø¯ÙŠ." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1220;--muted:#9aa7bd;--text:#eef3ff;--accent:#7c5cff;--danger:#ef4444;--border:rgba(255,255,255,.08);--shadow:0 12px 35px rgba(0,0,0,.35);--radius:16px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 800px at 80% -20%,rgba(124,92,255,.35),transparent 55%),radial-gradient(900px 700px at 10% 0%,rgba(34,197,94,.18),transparent 55%),var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;}
    .wrap{width:min(980px,100%)}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,rgba(124,92,255,.95),rgba(34,197,94,.75));box-shadow:var(--shadow);display:grid;place-items:center;font-size:22px}
    h1{margin:0;font-weight:800}
    .subtitle{margin:4px 0 0;color:var(--muted);font-size:14px}
    .pill{border:1px solid var(--border);padding:10px 12px;border-radius:999px;color:var(--muted);font-size:13px;display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.03)}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}header{flex-direction:column;align-items:flex-start}}
    .card{background:rgba(18,26,43,.88);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .head{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .head h2{margin:0;font-size:16px;font-weight:800}
    .body{padding:16px 18px}
    label{display:block;margin:0 0 8px;color:var(--muted);font-size:13px}
    textarea,input{width:100%;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 12px;font-family:inherit;font-size:15px;outline:none}
    textarea{min-height:190px;resize:vertical;line-height:1.75}
    input{height:44px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:600px){.row{grid-template-columns:1fr}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;border-radius:12px;padding:11px 14px;font-family:inherit;font-weight:800;cursor:pointer;color:#0b1220;background:linear-gradient(135deg,var(--accent),#a78bfa)}
    button.secondary{background:rgba(255,255,255,.06);color:var(--text);border:1px solid var(--border);font-weight:700}
    button.danger{background:rgba(239,68,68,.12);color:#fecaca;border:1px solid rgba(239,68,68,.28);font-weight:800}
    button.copy{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.28);color:#bbf7d0}
    .hint{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.7}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--muted);line-height:1.7}
    .msg strong{color:var(--text)}
    .hide{display:none!important}
    hr{border:0;border-top:1px solid var(--border);margin:12px 0}
    .tiny{font-size:12px;color:var(--muted)}
    .footer{margin-top:14px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">ğŸ</div>
        <div>
          <h1>Ù‡Ø¯ÙŠØ©</h1>
          <div class="subtitle" id="sub">Ø±Ø§Ø¨Ø· ÙˆØ§Ø­Ø¯: Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙˆØ´ÙˆÙ Ù…ÙŠÙ† Ø±Ø§Ø­ ØªÙ‡Ø¯ÙŠ</div>
        </div>
      </div>
      <div class="pill"><span>ğŸ”’</span><span>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§ ØªÙØ±Ø³Ù„ Ù„Ø£ÙŠ Ø³ÙŠØ±ÙØ±</span></div>
    </header>

    <!-- Organizer (no token in URL) -->
    <div id="organizerView" class="grid">
      <section class="card">
        <div class="head"><h2>Ø§Ù„Ù…Ù†Ø¸Ù‘Ù…: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø±Ø¹Ø©</h2><span class="badge">Ø­Ø¯ Ø£Ø¯Ù†Ù‰: 3 Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</span></div>
        <div class="body">
          <label for="eventName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="eventName" placeholder="Ù…Ø«Ø§Ù„: Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…ÙƒØªØ¨ / ÙØ¹Ø§Ù„ÙŠØ© Ø§Ù„Ù‚Ø±ÙˆØ¨" />

          <div class="row">
            <div><label for="budget">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="budget" placeholder="Ù…Ø«Ø§Ù„: 100 Ø±ÙŠØ§Ù„" /></div>
            <div><label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="notes" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù…Ù†ÙˆØ¹ Ù‡Ø¯Ø§ÙŠØ§ Ù…Ø²Ø§Ø­ Ø«Ù‚ÙŠÙ„Ø© ğŸ˜„" /></div>
          </div>

          <div style="margin-top:12px">
            <label for="names">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±)</label>
            <textarea id="names" placeholder="Ø³Ù„ÙŠÙ…Ø§Ù†&#10;ØªØ±ÙƒÙŠ&#10;Ù†ÙˆØ±Ø©&#10;Ø³Ø§Ø±Ø©"></textarea>
          </div>

          <div class="btns">
            <button id="btnMakeLink" type="button">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§Ø­Ø¯</button>
            <button id="btnShuffleOnly" class="secondary" type="button">Ø®Ù„Ø· ÙÙ‚Ø·</button>
            <button id="btnClear" class="danger" type="button">Ù…Ø³Ø­</button>
          </div>

          <div class="hint">
            âœ… Ø²Ø± <strong>ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§Ø­Ø¯</strong> ÙŠØ¹Ø·ÙŠÙƒ Ø±Ø§Ø¨Ø· ÙˆØ§Ø­Ø¯ ØªØ±Ø³Ù„Ù‡ Ù„Ù„Ø¬Ù…ÙŠØ¹.<br>
            âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø£ÙŠ Ø´Ø®Øµ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠÙ‚Ø¯Ø± ÙŠÙƒØªØ¨ Ø£ÙŠ Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙŠØ´ÙˆÙ Ù†ØªÙŠØ¬ØªÙ‡ (Ù‡Ø°Ø§ Ø·Ø¨ÙŠØ¹ÙŠ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„).
          </div>
        </div>
      </section>

      <section class="card">
        <div class="head"><h2>Ø§Ù„Ø±Ø§Ø¨Ø·</h2><span class="badge">Ø§Ù†Ø³Ø® ÙˆØ£Ø±Ø³Ù„</span></div>
        <div class="body">
          <div id="linkBox" class="msg">Ø§Ø¶ØºØ· <strong>ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§Ø­Ø¯</strong> Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§.</div>
          <div class="btns">
            <button id="btnCopyLink" class="copy hide" type="button">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
            <button id="btnOpenGuest" class="secondary hide" type="button">ÙØªØ­ ÙƒØ¶ÙŠÙ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)</button>
          </div>
          <div class="footer">
            <div>Â© <span id="year"></span> Ù‡Ø¯ÙŠØ©</div>
            <div class="tiny">Ù†ØµÙŠØ­Ø©: Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ø§ Ù…Ø¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†.</div>
          </div>
        </div>
      </section>
    </div>

    <!-- Guest (token in URL) -->
    <div id="guestView" class="card hide">
      <div class="head"><h2>Ø§Ù„Ø¶ÙŠÙ: Ø§Ø¹Ø±Ù Ù†ØªÙŠØ¬ØªÙƒ</h2><span class="badge">Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ</span></div>
      <div class="body">
        <div id="guestMeta" class="msg"></div>

        <label for="guestName">Ø§Ø³Ù…Ùƒ (Ù…Ø«Ù„ Ù…Ø§ ÙƒØªØ¨Ù‡ Ø§Ù„Ù…Ù†Ø¸Ù‘Ù…)</label>
        <input id="guestName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." />

        <div class="btns">
          <button id="btnShow" type="button">Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬ØªÙŠ</button>
          <button id="btnCopyResult" class="copy hide" type="button">Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        </div>

        <div id="resultBox" class="msg hide"></div>

        <div class="footer">
          <div>Â© <span id="year2"></span> Ù‡Ø¯ÙŠØ©</div>
          <div class="tiny">Ø¥Ø°Ø§ Ù…Ø§ Ø·Ù„Ø¹ Ø§Ø³Ù…ÙƒØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø·.</div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  $("year").textContent = new Date().getFullYear();
  $("year2").textContent = new Date().getFullYear();

  const organizerView = $("organizerView");
  const guestView = $("guestView");

  // --- Helpers ---
  function normalizeNames(text){
    return text.split("\n").map(s=>s.trim()).filter(Boolean).filter((v,i,a)=>a.indexOf(v)===i);
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  function buildCycle(names){
    const shuffled = shuffle([...names]);
    const map = {};
    for(let i=0;i<shuffled.length;i++){
      map[shuffled[i]] = shuffled[(i+1)%shuffled.length];
    }
    return {shuffled, map};
  }

  // base64url(JSON(payload))
  function b64urlEncode(str){
    const b64 = btoa(unescape(encodeURIComponent(str)));
    return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }
  function b64urlDecode(str){
    const pad = str.length % 4 ? '='.repeat(4-(str.length%4)) : '';
    const b64 = (str+pad).replace(/-/g,'+').replace(/_/g,'/');
    return decodeURIComponent(escape(atob(b64)));
  }

  function baseUrl(){
    return location.origin + location.pathname;
  }

  async function copyText(txt){
    try{ await navigator.clipboard.writeText(txt); return true; }
    catch(e){ return false; }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function parseTokenFromHash(){
    const h = location.hash || "";
    const m = h.match(/(?:^|#|&)d=([^&]+)/);
    return m ? m[1] : null;
  }

  // --- Organizer actions ---
  const linkBox = $("linkBox");
  const btnCopyLink = $("btnCopyLink");
  const btnOpenGuest = $("btnOpenGuest");

  $("btnMakeLink").onclick = async () => {
    const names = normalizeNames($("names").value);
    if(names.length < 3){ alert("Ø£Ø¯Ø®Ù„ 3 Ø£Ø³Ù…Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; }

    const title = ($("eventName").value||"").trim();
    const bud = ($("budget").value||"").trim();
    const note = ($("notes").value||"").trim();

    const assignment = buildCycle(names);

    // pack: event meta + mapping (as array of [giver, receiver])
    const pairs = Object.keys(assignment.map).map(k => [k, assignment.map[k]]);
    const payload = {v:1, eventName:title, budget:bud, notes:note, pairs};

    const token = b64urlEncode(JSON.stringify(payload));
    const link = baseUrl() + "#d=" + token;

    linkBox.innerHTML = `âœ… Ù‡Ø°Ø§ Ù‡Ùˆ <strong>Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§Ø­Ø¯</strong> â€” Ø§Ù†Ø³Ø®Ù‡ ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„Ù„Ø¬Ù…ÙŠØ¹:<br><span class="tiny" style="word-break:break-all">${escapeHtml(link)}</span>`;
    btnCopyLink.classList.remove("hide");
    btnOpenGuest.classList.remove("hide");

    btnCopyLink.onclick = async () => {
      const ok = await copyText(link);
      if(ok){
        btnCopyLink.textContent = "âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®";
        setTimeout(()=>btnCopyLink.textContent="Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·",1200);
      }else{
        prompt("Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠÙ‹Ø§:", link);
      }
    };

    btnOpenGuest.onclick = () => {
      // open same page with token so you can test guest flow
      window.open(link, "_blank");
    };
  };

  $("btnShuffleOnly").onclick = () => {
    const names = normalizeNames($("names").value);
    if(names.length < 2){ alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; }
    $("names").value = shuffle([...names]).join("\n");
  };

  $("btnClear").onclick = () => {
    if(!confirm("ØªØ¨ØºÙ‰ ØªÙ…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡ØŸ")) return;
    $("names").value=""; $("eventName").value=""; $("budget").value=""; $("notes").value="";
    linkBox.innerHTML = "Ø§Ø¶ØºØ· <strong>ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§Ø­Ø¯</strong> Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§.";
    btnCopyLink.classList.add("hide");
    btnOpenGuest.classList.add("hide");
  };

  // --- Guest mode ---
  function showGuest(payload){
    organizerView.classList.add("hide");
    guestView.classList.remove("hide");
    $("sub").textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙˆØ´ÙˆÙ Ù†ØªÙŠØ¬ØªÙƒ";

    const lines = [];
    if(payload.eventName) lines.push(`ğŸ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©: <strong>${escapeHtml(payload.eventName)}</strong>`);
    if(payload.budget) lines.push(`ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: <strong>${escapeHtml(payload.budget)}</strong>`);
    if(payload.notes) lines.push(`ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: <strong>${escapeHtml(payload.notes)}</strong>`);
    if(!lines.length) lines.push("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬ØªÙƒ.");
    $("guestMeta").innerHTML = lines.join("<br>");

    const map = new Map(payload.pairs || []);

    const resultBox = $("resultBox");
    const btnCopyResult = $("btnCopyResult");

    $("btnShow").onclick = () => {
      const name = ($("guestName").value||"").trim();
      if(!name){ alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„."); return; }
      if(!map.has(name)){
        resultBox.classList.remove("hide");
        btnCopyResult.classList.add("hide");
        resultBox.innerHTML = `âŒ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ù…Ø«Ù„ Ù…Ø§ ÙƒØªØ¨Ù‡ Ø§Ù„Ù…Ù†Ø¸Ù‘Ù….`;
        return;
      }
      const receiver = map.get(name);

      resultBox.classList.remove("hide");
      resultBox.innerHTML = `âœ… ÙŠØ§ <strong>${escapeHtml(name)}</strong>ØŒ Ø£Ù†Øª Ø±Ø§Ø­ ØªÙ‡Ø¯ÙŠ: <strong>${escapeHtml(receiver)}</strong> ğŸ`;

      const shareLines = [];
      if(payload.eventName) shareLines.push(`ğŸ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©: ${payload.eventName}`);
      if(payload.budget) shareLines.push(`ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${payload.budget}`);
      if(payload.notes) shareLines.push(`ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: ${payload.notes}`);
      shareLines.push("");
      shareLines.push(`${name}ØŒ Ø£Ù†Øª Ø±Ø§Ø­ ØªÙ‡Ø¯ÙŠ: ğŸ ${receiver}`);
      const shareText = shareLines.join("\n");

      btnCopyResult.classList.remove("hide");
      btnCopyResult.onclick = async () => {
        const ok = await copyText(shareText);
        if(ok){
          btnCopyResult.textContent = "âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®";
          setTimeout(()=>btnCopyResult.textContent="Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©",1200);
        }else{
          prompt("Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§:", shareText);
        }
      };
    };
  }

  const t = parseTokenFromHash();
  if(t){
    try{
      const payload = JSON.parse(b64urlDecode(t));
      if(!payload || !payload.pairs) throw new Error("bad");
      showGuest(payload);
    }catch(e){
      alert("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù.");
    }
  }
})();
</script>
</body>
</html>
